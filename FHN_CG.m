%---------------?????????????FHN????????????????-----------------------------
function FHN_CG()
clc
clear

m1 = 256;     % x?????????????
m2 = 256;     % y?????????????
m1_half = m1/2; 
m2_half = m2/2;
N = m1_half*m2_half;
M = (m1 - 1)*(m2 - 1); % ???????A?????

alpha1 = 1.7;   % x??????????
alpha2 = 1.7;   % y??????????
Dx = 2.5;       % x??????????
Dy = 2.5;       % y??????????
Kx = 0.0001;    % x??????????
Ky = 0.0001;    % y??????????
hx = Dx/m1;   % x?????????
hy = Dy/m2;   % y?????????
tau = 0.1;   % ?????
t = 1000;     % ??????
layend = t / tau;  % ???????????

%-----FHN????§Ó???????---------%
a=0.1;        
epsilon = 0.01;
beta=0.5;
gamma = 1;
delta=0;

Ca1 = 1.0/(2 * cos(pi * alpha1 / 2)); % x????Rieze?????????????????
Ca2 = 1.0/(2 * cos(pi * alpha2 / 2)); % y????Rieze?????????????????

r1 = (-1) * (tau* Kx * Ca1)/(hx^alpha1); 
r2 = (-1) * (tau * Ky * Ca2)/(hy^alpha2);

%-----x??y??????????------%
xx=linspace(0,Dx,m1-1);
yy=linspace(0,Dy,m2-1);
xx=repmat(xx,1,m1-1)';
yy=repmat(yy,m2-1,1);
yy=reshape(yy,M,1);

%% initial values of u,v 
u = zeros(m1-1,m2-1); 
v = zeros(m1-1,m2-1);
for i = 1:m1-1
    for j = 1:m2-1
        if( ( i < m1_half ) && ( j <= m2_half ) ) % u?????????????????1
            u( i,j ) = 1.0;
        else
            u( i ,j  ) = 0.0;
        end
        if( ( i >= m1_half ) && ( i < m1 ) )    % v??????????1
            v( i,j  ) = 0.1;
        else
            v( i,j) = 0.0;
        end
    end
end

%% initial Gruwald weights g(L)
g1 = zeros(1,m1+1);
g2 = zeros(1,m1+1);
g1(1) = 1.0;
g2(1) = 1.0;
for L = 1:m1
    g1(L+1)=-1*g1(L)*(alpha1-L+1)/L;
    g2(L+1)=-1*g2(L)*(alpha2-L+1)/L;
end

% Coefficient Matix A
A=sparse(M,M);
%??????0????????
for i = 1:m1-1
    for j = 1:m2-1
        A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j) = 1.0;  %???????????????
        if i == m1-1  % ??????????
                A((i-1)*(m2-1)+j,(i-(1:i)+1-1)*(m2-1)+j) = A((i-1)*(m2-1)+j,(i-(1:i)+1-1)*(m2-1)+j)+(-1*r1 * g1((1:i)+1));
        else
                A((i-1)*(m2-1)+j,(i-(0:i)+1-1)*(m2-1)+j) = A((i-1)*(m2-1)+j,(i-(0:i)+1-1)*(m2-1)+j)+(-1*r1 * g1((0:i)+1));
        end
        %???i??1??i+1?????????j??j????????
        if i == 1    % ??????????
                A((i-1)*(m2-1)+j,(i+(1:m1-i)-1-1)*(m2-1)+j) = A((i-1)*(m2-1)+j,(i+(1:m1-i)-1-1)*(m2-1)+j)+(-1*r1 * g1((1:m1-i)+1));
        else
                A((i-1)*(m2-1)+j,(i+(0:m1-i)-1-1)*(m2-1)+j) = A((i-1)*(m2-1)+j,(i+(0:m1-i)-1-1)*(m2-1)+j)+(-1*r1 * g1((0:m1-i)+1));
        end
        if j == m2-1   %?¡À????????
                A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j-(1:j)+1) = A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j-(1:j)+1)+(-1*r2* g2((1:j)+1));
        else
                A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j-(0:j)+1) = A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j-(0:j)+1)+(-1*r2 * g2((0:j)+1));
        end
        if j == 1      % ??????????
                A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j+(1:m2-j)-1) = A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j+(1:m2-j)-1)+(-1*r2 * g2((1:m2-j)+1));
        else
                A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j+(0:m2-j)-1) = A((i-1)*(m2-1)+j,(i-1)*(m2-1)+j+(0:m2-j)-1)+(-1*r2* g2((0:m2-j)+1));
        end
    end
        fprintf('??????A????????%f \n',i);     % ???????A???????????
end
fprintf('Matrix A is over\n');      % ????A???????



cd('C:\Users\Administrator\Desktop');  % ??????????current directory
% %
mkdir('Alpha1.7ofGuo');
cd('C:\Users\Administrator\Desktop\Alpha1.7ofGuo'); 
save A A;
%% ???????????
tol = 1.0e-7;  % the tolerance for the PCG method
it_max = 4000; % the maximum number of iterations for the PCG method
for lay = 1:layend   %?????
   % comute the right-hand side b
    b = u + tau * ( u .* ( 1 - u ) .* ( u - a ) - v );     % ??????????
    b=reshape(b',M,1);   %m1*m2??
    u0 = bicg(A,b,tol,it_max);     % ???????????Au=b
    u=reshape(u0,m1-1,m2-1)';  % M???????(m1-1)*(m2-1)?????
    
   %% solve_v
    v = v + epsilon*tau*( beta * u -gamma * v -delta );  % ?????????
                                                         %  ???v   
    %% ????????u?›¥? techplot ??????
    if( mod(lay,100) ==0 ) % ???100??›¥???
        uu=[xx,yy,reshape(u',(m1-1)*(m1-1),1)];
        [row,col]=size(uu);
        %         str=['data_',num2str(lay),'.plt'];
        folderName{i} = ['Lay', num2str(lay),'.txt'];
        fid=fopen(folderName{i},'w+');
        fprintf(fid,'TITLE="contour of the solution"\n');
        fprintf(fid,'VARIABLES="x","y","u"\n');
        fprintf(fid,'ZONE T="BOX",I= 256,J= 256,F=POINT\n');
        for i=1:row
            for j=1:col
                if j==col
                    fprintf(fid,'%g\n',uu(i,j));
                else
                    fprintf(fid,'%g\t',uu(i,j));
                end
            end
        end
        fclose(fid);                                                   
        
        fprintf('???????%f \n',lay);
    end
end

% contour(u)   % ????u???????